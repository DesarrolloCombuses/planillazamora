<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planilla – Viajes Zamora</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --bg:#f8f9fa; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; --zebra:#f3f4f6; }
    body.dark{ --bg:#0f172a; --card:#0b1220; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937; --accent:#3b82f6; --zebra:#111827; }
    body{ background:var(--bg); color:var(--text); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:1rem; }
    .required::after{ content:" *"; color:#dc2626; }
    input[type="text"], select, textarea { text-transform: uppercase; }
    .table-sm td,.table-sm th{ padding:.45rem .5rem; }
    .nav-pills .nav-link.active{ background:var(--accent); }
    .table thead th{ cursor:pointer; user-select:none; white-space:nowrap; }
    .table-striped>tbody>tr:nth-of-type(odd)>*{ background-color:var(--zebra); }
    .stat{ background:var(--card); border:1px solid var(--border); border-radius:.75rem; padding:.75rem 1rem; }
    .stat .k{ font-weight:700; font-size:1.15rem; }
    .toolbar .form-control{ background:var(--card); color:var(--text); border:1px solid var(--border); }
    .spinner{ width:14px; height:14px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite; display:inline-block; vertical-align:text-bottom; }
    @keyframes spin{ to{ transform:rotate(360deg)} }

    /* ======= Mejora UI móvil / táctil ======= */
    html { font-size:16px; }
    @media (max-width: 576px){
      html { font-size:18px; }
      body { line-height:1.35; }
      .container{ padding-left:12px; padding-right:12px; }
      .card{ width:100%; border-radius:1rem; padding:1rem !important; }
      .stat .k{ font-size:1.35rem; } .stat .t{ font-size:1rem; }
      .toolbar{ display:flex; flex-direction:column; align-items:stretch; gap:.5rem; }
      .toolbar > *{ width:100% !important; } .toolbar .btn-group,.toolbar .dropdown-menu{ width:100%; }
      .nav-pills .nav-link{ padding:.6rem 1rem; font-size:1rem; border-radius:.75rem; }
      .table-sm td,.table-sm th{ padding:.8rem .75rem; font-size:1rem; }
      .form-control,.form-select{ padding:.7rem .9rem; font-size:1rem; border-radius:.65rem; }
      button.btn.btn-primary{ padding:.8rem 1rem; font-size:1.05rem; border-radius:.8rem; }
      #pager .btn{ padding:.6rem .9rem; font-size:1rem; }
    }
    #historicoCard,.card{ max-width:none; }
  </style>
</head>
<body>
<div class="container py-4">
  <!-- Encabezado / modo oscuro -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">📋 Planilla – Viajes Zamora</h3>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="darkToggle">
      <label class="form-check-label" for="darkToggle">Modo oscuro</label>
    </div>
  </div>

  <!-- FORM -->
  <div class="card shadow p-4">
    <form id="formPerdidos" class="row g-3" autocomplete="off">
      <div class="col-md-3">
        <label class="form-label required">FECHA</label>
        <input type="date" name="FECHA" id="fechaInput" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label required">VH</label>
        <select name="VH" id="vhSelect" class="form-select" required>
          <option value="">SELECCIONE...</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label required">PLACA</label>
        <input type="text" name="PLACA" id="placaInput" class="form-control" readonly required>
      </div>
      <div class="col-md-2">
        <label class="form-label required">TABLA</label>
        <input type="text" name="TABLA" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label required">V.REALIZADOS</label>
        <input type="number" inputmode="numeric" name="V.REALIZADOS" class="form-control" required>
      </div>

      <!-- categorías de perdidos -->
      <div class="col-md-2">
        <label class="form-label">PERDIDOS TALLER</label>
        <input type="number" inputmode="numeric" name="VIAJES PERDIDOS TALLER" class="form-control perd" value="0" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">PERDIDOS RESTRICCIÓN</label>
        <input type="number" inputmode="numeric" name="VIAJES PERDIDOS RESTRICCION" class="form-control perd" value="0" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">PERDIDOS INASISTENCIA</label>
        <input type="number" inputmode="numeric" name="VIAJES PERDIDOS INASISTENCIA" class="form-control perd" value="0" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">PERDIDOS EPS</label>
        <input type="number" inputmode="numeric" name="VIAJES PERDIDOS EPS" class="form-control perd" value="0" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">PERDIDOS PERMISO</label>
        <input type="number" inputmode="numeric" name="VIAJES PERDIDOS PERMISO" class="form-control perd" value="0" required>
      </div>
      <div class="col-md-2">
        <label class="form-label required">PERDIDOS TOTAL</label>
        <input type="number" inputmode="numeric" name="VIAJES PERDIDOS TOTAL" id="perdidosTotal" class="form-control" readonly required>
      </div>

      <!-- Conductor desde hoja -->
      <div class="col-md-4">
        <label class="form-label required">NOMBRE DE CONDUCTOR</label>
        <select name="NOMBRE DE CONDUCTOR" id="conductorSelect" class="form-select" required>
          <option value="">CARGANDO...</option>
        </select>
      </div>
      <div class="col-md-8">
        <label class="form-label">OBSERVACIONES</label>
        <input type="text" name="OBSERVACIONES" class="form-control" required>
      </div>

      <div class="col-md-3">
        <label class="form-label required">TURNO DEL GESTOR</label>
        <select name="TURNO DEL GESTOR" id="turnoGestor" class="form-select" required>
          <option value="">SELECCIONE...</option>
          <option value="AM">AM</option>
          <option value="PM">PM</option>
        </select>
      </div>
      <div class="col-md-5">
        <label class="form-label required">NOMBRE DEL GESTOR</label>
        <input type="text" name="NOMBRE DEL GESTOR" class="form-control" required>
      </div>

      <div class="col-12 d-flex align-items-center gap-3">
        <button type="submit" class="btn btn-primary">Agregar Registro</button>
        <span id="dupInfo" class="badge text-bg-warning d-none">Este VH ya fue ingresado para la fecha</span>
        <span id="syncInfo" class="text-muted d-none"><span class="spinner"></span> Sincronizando…</span>
      </div>
    </form>
  </div>

  <!-- STATS -->
  <div class="row mt-4 g-3">
    <div class="col-md-4"><div class="stat"><div class="k" id="statHechos">0</div><div class="t">Hechos para la fecha seleccionada</div></div></div>
    <div class="col-md-4"><div class="stat"><div class="k" id="statTotalVeh">0</div><div class="t">Total de VH en la lista</div></div></div>
    <div class="col-md-4"><div class="stat"><div class="k" id="statFaltan">0</div><div class="t">Faltantes para esa fecha</div></div></div>
  </div>

  <!-- HISTÓRICO -->
  <div class="card shadow p-4 mt-4" id="historicoCard">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-2 gap-2">
      <h5 class="mb-0">📡 Registros guardados</h5>
      <div class="d-flex align-items-center gap-2 toolbar">
        <input id="searchInput" type="text" class="form-control form-control-sm" placeholder="Buscar en histórico" style="min-width:260px;">
        <button class="btn btn-outline-secondary btn-sm" id="btnClear">Limpiar</button>
        <button class="btn btn-outline-secondary btn-sm" id="btnRefresh">Actualizar</button>
        <div class="btn-group">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">Exportar CSV</button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="exportCsvPage">Página actual</a></li>
            <li><a class="dropdown-item" href="#" id="exportCsvAll">Todo filtrado</a></li>
          </ul>
        </div>
        <div class="btn-group">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">Exportar Excel</button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="exportXlsxPage">Página actual</a></li>
            <li><a class="dropdown-item" href="#" id="exportXlsxAll">Todo filtrado</a></li>
          </ul>
        </div>
      </div>
    </div>

    <ul class="nav nav-pills gap-2 mb-3" id="tabsRango">
      <li class="nav-item"><button class="nav-link active" data-range="hoy">Hoy</button></li>
      <li class="nav-item"><button class="nav-link" data-range="semana">Semana</button></li>
      <li class="nav-item"><button class="nav-link" data-range="mes">Mes</button></li>
      <li class="nav-item"><button class="nav-link" data-range="historico">Histórico</button></li>
    </ul>

    <div class="table-responsive">
      <table class="table table-sm table-striped" id="tablaRemota">
        <thead id="theadRemoto"></thead>
        <tbody id="tbodyRemoto"></tbody>
      </table>
    </div>

    <div class="d-flex align-items-center justify-content-between mt-2" id="pager" style="display:none;">
      <div class="small text-muted" id="pagerInfo"></div>
      <div class="btn-group">
        <button class="btn btn-outline-secondary btn-sm" id="prevPage">« Anterior</button>
        <button class="btn btn-outline-secondary btn-sm" id="nextPage">Siguiente »</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Bootstrap -->
<div class="position-fixed bottom-0 start-50 translate-middle-x p-3" style="z-index:1100">
  <div id="toast" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div id="toastMsg" class="toast-body">OK</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script>
  /* ================== CONFIG (cambia solo esto) ================== */
  const WEB_APP_URL   = "https://script.google.com/macros/s/AKfycbzOiae29CImB1TTXq2ph6SEm-QeVkKGNqc8-w1eGH7LHxuQwC99tCuz_hMjUg_3B-fT/exec"; // <-- tu Apps Script desplegado
  const HIST_SHEET_ID = "1vjqWE4AxYmTK7SgQw68OqP4OPT651uXcmrnEzfAyq2s";
  const HIST_SHEET_TAB= "resumen zamora";

  const COND_ID   = "1D_InxpCqqM4qzoWiDV4MZt-7dpmmMxdwCZotjpGDaME";
  const COND_TAB  = "Conductores urbanos";

  // Endpoints a Apps Script
  const OPERADORES_URL = `${WEB_APP_URL}?format=json&id=${COND_ID}&sheet=${encodeURIComponent(COND_TAB)}`;
  const HISTORICO_URL  = `${WEB_APP_URL}?format=csv&id=${HIST_SHEET_ID}&sheet=${encodeURIComponent(HIST_SHEET_TAB)}`;
  const GAS_EXEC_URL   = WEB_APP_URL;

  const AUTO_REFRESH_MS=15000, POLL_CONFIRM_MS=20000, POLL_INTERVAL_MS=2000, PAGE_SIZE_HIST=100;

  // VH -> PLACA
  const vehPlacaMap = {"17":"EQR993","25":"SMT896","30":"EQT486","85":"TSH519","101":"WDX404","108":"EQS995","113":"EQT504","114":"TSJ401","134":"EQW271","156":"SMV802","183":"STV612","185":"TSG893","187":"TSI191","188":"EQW431","189":"TSE779","190":"SMT664","192":"TPU783","193":"TSG527","194":"TPV338","195":"TSE553","198":"TSH271","216":"STW894","217":"FWK177","223":"SMT831","237":"TSI855","238":"STV611","239":"TSI641","243":"TPV865","266":"WPT149","269":"TSI732","305":"SMU568"};
  const VEH_LIST = Object.keys(vehPlacaMap).sort((a,b)=>parseInt(a)-parseInt(b));

  /* ================== Helpers/estado ================== */
  const pad=n=>String(n).padStart(2,'0');
  const normKey=s=>(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9]/g,"").toLowerCase();
  function formatDMY(iso){ if(!iso) return ""; const [y,m,d]=iso.split("-"); return `${pad(d)}/${pad(m)}/${y}`; }
  function nowDMYHMS(){ const t=new Date(); return `${pad(t.getDate())}/${pad(t.getMonth()+1)}/${t.getFullYear()} ${pad(t.getHours())}:${pad(t.getMinutes())}:${pad(t.getSeconds())}`; }
  let remoto=[], headersRemotos=[], activeRange="hoy", searchQuery="", sortKey=null, sortDir=1, currentPage=1, autoRefreshTimer=null, syncing=false;

  // Modo oscuro
  (function(){const t=document.getElementById("darkToggle"); const apply=()=>{const d=localStorage.getItem("darkMode")==="1"; document.body.classList.toggle("dark",d); t.checked=d;}; t.addEventListener("change",()=>{localStorage.setItem("darkMode",t.checked?"1":"0"); apply();}); apply();})();

  // Toast
  function showToast(msg, ok=true){
    const el=document.getElementById("toast");
    document.getElementById("toastMsg").textContent=msg;
    el.classList.toggle("text-bg-success", ok);
    el.classList.toggle("text-bg-danger", !ok);
    new bootstrap.Toast(el,{delay:2500}).show();
  }

  // Conductores (JSON vía GAS)
  async function cargarConductores(){
    const sel=document.getElementById("conductorSelect");
    try{
      const r=await fetch(OPERADORES_URL,{mode:"cors",cache:"no-store"});
      const data=await r.json();
      const headers=Object.keys(data[0]||{});
      const keyNombre=headers.find(h=>h.toLowerCase().includes("nombre"));
      if(!keyNombre){ sel.innerHTML='<option value="">NO SE ENCONTRÓ COLUMNA NOMBRE</option>'; return; }
      const nombres=[...new Set(data.map(row=>(row[keyNombre]||"").toString().trim().toUpperCase()))]
        .filter(Boolean).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
      sel.innerHTML='<option value="">SELECCIONE...</option>'+nombres.map(n=>`<option value="${n}">${n}</option>`).join("");
    }catch(e){ console.error(e); sel.innerHTML='<option value="">ERROR CARGANDO LISTA</option>'; }
  }

  // Histórico (CSV vía GAS)
  async function cargarRemoto(){
    try{
      const txt = await (await fetch(HISTORICO_URL,{mode:"cors",cache:"no-store"})).text();
      const parsed=Papa.parse(txt,{header:true,skipEmptyLines:true});
      headersRemotos=parsed.meta.fields||Object.keys(parsed.data[0]||{});
      remoto=parsed.data.map(r=>{const o={}; headersRemotos.forEach(h=>o[h]=r[h]??""); return o;});
    }catch(e){ console.warn("Histórico no disponible:",e); headersRemotos=[]; remoto=[]; }
  }

  // Tabla/UI
  function fechaToDate(v){ const f=(v||"").toString().trim(); const [d,m,y]=f.split("/"); if(!d||!m||!y) return null; return new Date(`${y}-${m}-${d}T00:00:00`); }
  function colFecha(){ return headersRemotos.find(h=>normKey(h)==="fecha"); }
  function colVH(){ return headersRemotos.find(h=>normKey(h)==="vh"); }
  function filtrarPorRango(){ if(!headersRemotos.length) return []; const hoy=new Date(); hoy.setHours(0,0,0,0); let desde=new Date(hoy); if(activeRange==="semana") desde.setDate(hoy.getDate()-7); if(activeRange==="mes") desde.setDate(hoy.getDate()-30); const hF=colFecha(); if(!hF) return remoto.slice(); if(activeRange==="historico") return remoto.slice(); return remoto.filter(r=>{ const d=fechaToDate(r[hF]); if(!d) return false; if(activeRange==="hoy") return d.getTime()===hoy.getTime(); return d>=desde; }); }
  function filtrarPorBusqueda(rows){ const q=searchQuery.trim().toUpperCase(); if(!q) return rows; return rows.filter(r=>Object.values(r).some(v=>(v||"").toString().toUpperCase().includes(q))); }
  function ordenarRows(rows){ if(!sortKey) return rows; const dir=sortDir; return rows.slice().sort((a,b)=>{ const av=(a[sortKey]??"").toString(), bv=(b[sortKey]??"").toString(); const an=parseFloat(av.replace(",",".")), bn=parseFloat(bv.replace(",",".")); const num=!isNaN(an)&&!isNaN(bn); return (num?(an-bn):av.localeCompare(bv,'es',{numeric:true,sensitivity:'base'}))*dir; }); }
  function paginateRows(rows){ if(activeRange!=="historico"){ document.getElementById("pager").style.display="none"; return rows; } const total=rows.length, pages=Math.max(1,Math.ceil(total/PAGE_SIZE_HIST)); if(currentPage>pages) currentPage=pages; const s=(currentPage-1)*PAGE_SIZE_HIST, e=s+PAGE_SIZE_HIST; document.getElementById("pager").style.display="flex"; document.getElementById("pagerInfo").textContent=`Página ${currentPage} de ${pages} · ${total} filas`; document.getElementById("prevPage").disabled=currentPage===1; document.getElementById("nextPage").disabled=currentPage===pages; return rows.slice(s,e); }
  function renderRemoto(){ const thead=document.getElementById("theadRemoto"), tbody=document.getElementById("tbodyRemoto"); thead.innerHTML=""; tbody.innerHTML=""; if(!headersRemotos.length){ thead.innerHTML="<tr><th>Sin datos</th></tr>"; return; } const trh=document.createElement("tr"); headersRemotos.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; const span=document.createElement("span"); span.className="ms-1 text-muted"; if(sortKey===h) span.textContent=sortDir===1?"▲":"▼"; th.appendChild(span); th.addEventListener("click",()=>{ if(sortKey===h) sortDir=-sortDir; else{ sortKey=h; sortDir=1; } currentPage=1; renderRemoto(); }); trh.appendChild(th); }); thead.appendChild(trh); const rows=paginateRows( ordenarRows( filtrarPorBusqueda( filtrarPorRango() ) ) ); const frag=document.createDocumentFragment(); rows.forEach(r=>{ const tr=document.createElement("tr"); headersRemotos.forEach(h=>{ const td=document.createElement("td"); td.textContent=r[h]??""; tr.appendChild(td); }); frag.appendChild(tr); }); tbody.appendChild(frag); }

  // Stats / duplicado
  function actualizarStats(){ const f=formatDMY(document.getElementById("fechaInput").value); const hF=colFecha(); let hechos=0; if(hF) hechos=remoto.filter(r=>(r[hF]||"").trim()===f).length; document.getElementById("statHechos").textContent=hechos; document.getElementById("statTotalVeh").textContent=VEH_LIST.length; document.getElementById("statFaltan").textContent=Math.max(0,VEH_LIST.length-hechos); }
  function existeRegistro(fechaDDMMYYYY, vh){ const hF=colFecha(), hV=colVH(); if(!hF||!hV) return false; return remoto.some(r=> (r[hF]||"")===fechaDDMMYYYY && (r[hV]||"")===vh ); }
  function checkDuplicadoUI(){ const f=formatDMY(document.getElementById("fechaInput").value); const v=document.getElementById("vhSelect").value; const ya=existeRegistro(f,v); document.getElementById("dupInfo").classList.toggle("d-none", !(f&&v&&ya)); return ya; }

  // Auto refresh & toolbar
  function startAutoRefresh(){ stopAutoRefresh(); autoRefreshTimer=setInterval(async()=>{ if(document.hidden||syncing) return; await cargarRemoto(); renderRemoto(); actualizarStats(); }, AUTO_REFRESH_MS); }
  function stopAutoRefresh(){ if(autoRefreshTimer) clearInterval(autoRefreshTimer); autoRefreshTimer=null; }
  document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) startAutoRefresh(); });
  document.getElementById("searchInput").addEventListener("input", e=>{ searchQuery=e.target.value; currentPage=1; renderRemoto(); });
  document.getElementById("btnClear").addEventListener("click", ()=>{ document.getElementById("searchInput").value=""; searchQuery=""; currentPage=1; renderRemoto(); });
  document.getElementById("prevPage").addEventListener("click", ()=>{ if(currentPage>1){ currentPage--; renderRemoto(); } });
  document.getElementById("nextPage").addEventListener("click", ()=>{ currentPage++; renderRemoto(); });
  document.querySelectorAll("#tabsRango .nav-link").forEach(b=> b.addEventListener("click", e=>{ document.querySelectorAll("#tabsRango .nav-link").forEach(x=>x.classList.remove("active")); e.target.classList.add("active"); activeRange=e.target.dataset.range; currentPage=1; renderRemoto(); }));

  // Perdidos total
  function calcPerdidosTotal(){ const sum=[...document.querySelectorAll(".perd")].reduce((a,i)=>a+(parseFloat(i.value||"0")||0),0); document.getElementById("perdidosTotal").value=sum; }
  document.querySelectorAll(".perd").forEach(i=> i.addEventListener("input", calcPerdidosTotal)); calcPerdidosTotal();

  // VH / PLACA
  (function fillVH(){ const sel=document.getElementById("vhSelect"); VEH_LIST.forEach(v=>{const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o);}); document.getElementById("statTotalVeh").textContent=VEH_LIST.length; })();
  document.getElementById("vhSelect").addEventListener("change", function(){ document.getElementById("placaInput").value=vehPlacaMap[this.value]||""; checkDuplicadoUI(); });
  document.getElementById("fechaInput").addEventListener("change", ()=>{ actualizarStats(); checkDuplicadoUI(); });

  // Envío directo a GAS
  document.getElementById("formPerdidos").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const form=e.currentTarget;
    if(!form.reportValidity()) return;

    calcPerdidosTotal();
    if (checkDuplicadoUI()){ showToast("Ya existe ese VH en la fecha.", false); return; }

    let data = Object.fromEntries(new FormData(form).entries());
    data["FECHA"] = formatDMY(data["FECHA"]);
    data["FECHA_HORA_ACCION"] = nowDMYHMS();
    for (let k in data){ if (typeof data[k]==="string" && k!=="FECHA" && k!=="FECHA_HORA_ACCION"){ if(isNaN(data[k])) data[k]=data[k].toUpperCase(); } }

    const payload = {
      id: HIST_SHEET_ID,
      sheet: HIST_SHEET_TAB,
      row: data
    };

    try{
      const r = await fetch(GAS_EXEC_URL, {
        method:"POST",
        mode:"cors",
        headers:{ "Content-Type":"text/plain;charset=utf-8" }, // evita preflight
        body: JSON.stringify(payload)
      });
      const res = await r.json();
      if(!res.ok) throw new Error(res.error||"Fallo al insertar");

      // inserción optimista
      if(headersRemotos.length){ const row={}; headersRemotos.forEach(h=> row[h]= data[h] ?? "" ); remoto.unshift(row); renderRemoto(); actualizarStats(); }

      // confirmación rápida
      const fecha=data["FECHA"], vh=data["VH"];
      const sync=document.getElementById("syncInfo"); syncing=true; sync.classList.remove("d-none");
      const start=Date.now();
      while(Date.now()-start < POLL_CONFIRM_MS){
        await new Promise(r=>setTimeout(r,POLL_INTERVAL_MS));
        await cargarRemoto(); renderRemoto(); actualizarStats();
        if (existeRegistro(fecha, vh)) break;
      }
      syncing=false; sync.classList.add("d-none");

      showToast("Registro guardado ✅", true);
      form.reset(); document.getElementById("placaInput").value="";
    }catch(err){
      console.error(err); showToast("Error guardando ❌", false);
    }
  });

  // Init
  (async function init(){
    await cargarConductores();
    await cargarRemoto(); renderRemoto(); actualizarStats(); startAutoRefresh();
  })();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

